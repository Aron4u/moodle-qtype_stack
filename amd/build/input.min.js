define ("qtype_stack/input",["core/ajax","core/event"],function(Ajax,CustomEvents){"use strict";function localizeToLocale(a){return a.replace(/,/g,";").replace(/\./g,",")}function localizeToMathJaxLocale(a){return a.replace(/,/g,";").replace(/\./g,"{,}")}function localizeFromLocaleToEnglish(a){return a.replace(/,/g,".").replace(/;/g,",")}function StackInput(validationDiv,prefix,qaid,name,input){var TYPING_DELAY=1e3,delayTimeoutHandle=null,validationResults={},lastValidatedValue=getInputValue();function cancelTypingDelay(){if(delayTimeoutHandle){clearTimeout(delayTimeoutHandle)}delayTimeoutHandle=null}input.addEventHandlers(valueChanging);function valueChanging(){cancelTypingDelay();showWaiting();delayTimeoutHandle=setTimeout(valueChanged,1000);setTimeout(function(){checkNoChange()},0)}function checkNoChange(){if(getInputValue()===lastValidatedValue){cancelTypingDelay();validationDiv.classList.remove("waiting")}}function valueChanged(){cancelTypingDelay();if(!showValidationResults()){validateInput()}}function validateInput(){Ajax.call([{methodname:"qtype_stack_validate_input",args:{qaid:qaid,name:name,input:getInputValue()},done:function done(a){validationReceived(a)},fail:function fail(a){showValidationFailure(a)}}]);showLoading()}function getInputValue(){return input.getValue()}function validationReceived(a){if("invalid"===a.status){showValidationFailure(a);return}validationResults[a.input]=a;showValidationResults()}function extractScripts(a,b){var c=/<script[^>]*>([\s\S]*?)<\/script>/g,d;while(null!==(d=c.exec(a))){b.push(d[1])}return a.replace(c,"")}function showValidationResults(){var val=getInputValue();if(!validationResults[val]){showWaiting();return!1}var results=validationResults[val];lastValidatedValue=val;var scriptCommands=[];validationDiv.innerHTML=extractScripts(results.message,scriptCommands);for(var i=0;i<scriptCommands.length;i++){eval(scriptCommands[i])}removeAllClasses();if(!results.message){validationDiv.classList.add("empty")}CustomEvents.notifyFilterContentUpdated(validationDiv);return!0}function showValidationFailure(a){lastValidatedValue="";validationDiv.innerHTML=a.message;removeAllClasses();validationDiv.classList.add("error");CustomEvents.notifyFilterContentUpdated(validationDiv)}function showLoading(){removeAllClasses();validationDiv.classList.add("loading")}function showWaiting(){removeAllClasses();validationDiv.classList.add("waiting")}function removeAllClasses(){validationDiv.classList.remove("empty");validationDiv.classList.remove("error");validationDiv.classList.remove("loading");validationDiv.classList.remove("waiting")}}function StackSimpleInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)};this.getValue=function(){var b=a.parentElement.querySelector("[name=\""+a.orgname+"\"]");if(b){b.value=this.transform();return b.value}return this.getValueOrg()};this.getValueOrg=function(){return a.value.replace(/^\s+|\s+$/g,"")};this.transform=function(){return localizeFromLocaleToEnglish(this.getValueOrg())}}function StackTextareaInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)};this.getValue=function(){var b=a.value.replace(/^\s+|\s+$/g,"");return b.split(/\s*[\r\n]\s*/).join("<br>")}}function StackRadioInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)};this.getValue=function(){var b=a.querySelector(":checked");if(b){return b.value}else{return""}}}function StackCheckboxInput(a){this.addEventHandlers=function(b){a.addEventListener("input",b)};this.getValue=function(){for(var b=a.querySelectorAll(":checked"),c=[],d=0;d<b.length;d++){c[d]=b[d].value}if(0<c.length){return c.join(",")}else{return""}}}function StackMatrixInput(a,b){var c=0,d=0;b.querySelectorAll("input[type=text]").forEach(function(b){if(b.name.slice(0,a.length+5)!==a+"_sub_"){return}createShadowElement(b);var e=b.name.substring(a.length+5).split("_");d=Math.max(d,parseInt(e[0],10)+1);c=Math.max(c,parseInt(e[1],10)+1)});this.addEventHandlers=function(a){b.addEventListener("input",a)};this.getValue=function(){for(var e=Array(d),f=0;f<d;f++){e[f]=Array(c)}b.querySelectorAll("input[type=text]").forEach(function(b){if(b.name.slice(0,a.length+5)!==a+"_sub_"){return}if(b.name.endsWith("_translate")){var d=b.parentElement.querySelector("[name=\""+b.orgname+"\"]");if(d){d.value=localizeFromLocaleToEnglish(b.value.replace(/^\s+|\s+$/g,""))}var c=d.name.substring(a.length+5).split("_");e[c[0]][c[1]]=d.value.replace(/^\s+|\s+$/g,"")}});return"matrix(["+e.join("],[")+"])"}}function initInputs(a,b,c,d,e){var f=document.getElementById(a);f.querySelectorAll("script").forEach(function(a){if(a.id.includes("MathJax")){if(a.type.includes("math/tex")){var b=MathJax.Hub.getJaxFor(a.id);if("de"===MathJax.Localization.locale&&!a.translated){b.translated=!0;b.text=localizeToMathJaxLocale(a.text)+" "}}}});if(window.MathJax){var g=null,h=function(){if(g){clearTimeout(g)}g=setTimeout(function(){MathJax.Hub.Reprocess(f)},500)};MathJax.Hub.Register.MessageHook("New Math Pending",function(a){var b=MathJax.Hub.getJaxFor(a[1]).SourceElement();if("de"===MathJax.Localization.locale&&!b.translated){b.translated=!0;b.text=localizeToMathJaxLocale(b.text)+" "}});MathJax.Hub.Register.MessageHook("End Process",function(){h()})}for(var j=document.getElementById(a),k=!0,l=0;l<d.length;l++){k=initInput(j,b,c,d[l],e)&&k}if(k&&(j.classList.contains("dfexplicitvaildate")||j.classList.contains("dfcbmexplicitvaildate"))){var m=j.querySelector(".im-controls input.submit");if(m){m.hidden=!0}}}function initInput(a,b,c,d,e){var f=document.getElementById(b+d+"_val");if(!f){return!1}var g=getInputTypeHandler(a,b,d,e);if(g){new StackInput(f,b,c,d,g);return!0}else{return!1}}function createShadowElement(a){var b=document.createElement("input");b.type=a.type;b.hidden=!0;a.parentElement.appendChild(b);a.orgname=a.name;if(a.id){a.orgid=a.id;b.id=a.id;a.id=a.id+"_translate"}a.orgvalue=a.value;b.value=a.value;a.value=localizeToLocale(a.orgvalue);b.name=a.name;a.name=a.name+"_translate"}function getInputTypeHandler(a,b,c,d){var e=a.querySelector("[name=\""+b+c+"\"]");if(e){if(","===d){createShadowElement(e)}if("TEXTAREA"===e.nodeName){return new StackTextareaInput(e)}else if("radio"===e.type){return new StackRadioInput(e.closest(".answer"))}else{return new StackSimpleInput(e)}}e=a.querySelector("[name=\""+b+c+"_1\"]");if(e&&"checkbox"===e.type){return new StackCheckboxInput(e.closest(".answer"))}var f=document.getElementById(b+c+"_container");if(f){return new StackMatrixInput(b+c,f)}return null}return{initInputs:initInputs}});
//# sourceMappingURL=input.min.js.map
